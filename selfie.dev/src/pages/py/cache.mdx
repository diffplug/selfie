import { DocsImage } from "@/components/DocsImage";

export const title = "Selfie Python Snapshot Testing | Caching";
export const description =
  "A snapshot can be used as a cache from which an expensive or non-deterministic operation can be read.";
export const imageUrl = "https://selfie.dev/cache.webp";

<DocsImage imgAbsoluteUrl={imageUrl} />

# Cache Functionality (Work in Progress)

> âš ï¸ **Note**: Cache functionality is currently under development ([Issue #302](https://github.com/diffplug/selfie/issues/302)).

The following examples demonstrate the basic cache functionality that is currently implemented:

```python
from selfie_lib import cache_selfie

def random_str():
    return str(random.random())

# Basic caching example
cache_selfie(lambda: str(random.random())).to_be("0.46009462251400757")
cache_selfie(random_str).to_be("0.6134874512330031")
```

## How it Works

To use `expect_selfie`, you pass a _value_ that you want to snapshot:

```python
expect_selfie(customer.firstName).to_be("Fred")
```

To use `cache_selfie`, you pass a **function** that **returns a value** to snapshot:

```python
cache_selfie(lambda: customer.firstName).to_be("Fred")
```

When selfie is in read mode, it can ignore the function and just return the value within the `to_be` call. When selfie is in write mode, it calls the function and sets the snapshot to that result.

## Benefits and Hazards

The benefit of `cache_selfie` is that we can take an expensive non-deterministic operation and build a cheap deterministic test on top of the cached value.

The hazard is that the cached result _is not testing the function call anymore_. It is just a convenient way to generate sample data for testing _other_ parts of the system.

> âš ï¸ **Important**: The function being cached is not being tested. The snapshot might be outdated or manually edited, making it different from what the function would actually return.

> ðŸš§ **Coming Soon**:
> - Typed data roundtripping ([PRs welcomed](https://github.com/diffplug/selfie))
> - Binary data handling
> - AI example implementation ([Issue #319](https://github.com/diffplug/selfie/issues/319))
> - String and binary data options
> - Filesystem-like snapshot storage

_Pull requests to improve the documentation are greatly appreciated, you can find the [source code here](https://github.com/diffplug/selfie)._
