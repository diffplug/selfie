import { DocsImage } from "@/components/DocsImage";

export const title = "Selfie Python Snapshot Testing | Facets";
export const description =
  "A single Selfie snapshot may contain multiple values, each recording a different facet of the entity under test. This allows you to assert on brief summary facets inline with your test code, while putting large exhaustive facets on disk.";
export const imageUrl = "https://selfie.dev/advanced.webp";

<DocsImage imgAbsoluteUrl={imageUrl} />

Assuming you have [installed selfie](/py/get-started#installation) and glanced through the [quickstart](/py/get-started#quickstart), then you're ready to start taking multifaceted snapshots of arbitrary typed data.

## Implementation Status

‚úÖ Implemented:
- Web examples with facets
- HTML pretty printing
- Markdown conversion
- Basic Camera and Lens functionality
- Status code handling
- Redirect handling

‚ö†Ô∏è Partially implemented:
- Advanced facet features
- Complex disk snapshots

‚ùå Not implemented/WIP:
- Garbage collection ([Issue #325](https://github.com/diffplug/selfie/issues/325))
- Advanced binary data handling

## Our toy project

We'll be using the [`example-pytest-selfie`](https://github.com/diffplug/selfie/tree/main/python/example-pytest-selfie) project from the selfie GitHub repo. You can clone the code and follow along, but there's no need to. If you did clone the project, you could run `python app.py` and you'd have a little flask webapp running at `127.0.0.1:5000`.

## Web Testing with Facets

Since it's a flask app, we can use its built-in test client to test our homepage:

```python
@pytest.fixture
def client():
    app.config["TESTING"] = True
    with app.test_client() as client:
        yield client

def test_homepage(client):
    web_selfie(client.get("/")).to_be("""<html>
 <body>
  <h1>
   Please login
  </h1>
  <form action="/login" method="post">
   <input name="email" placeholder="email" type="text"/>
   <input type="submit" value="login"/>
  </form>
 </body>
</html>

‚ïî‚ïê [md] ‚ïê‚ïó
Please login
‚ïî‚ïê [status] ‚ïê‚ïó
200 OK""")
```

## Cameras and Lenses

Selfie uses `Camera` to capture snapshots and `Lens` to transform them. Here's how we set up web testing:

```python
def _web_camera(response: TestResponse) -> Snapshot:
    redirect_reason = REDIRECTS.get(response.status_code)
    if redirect_reason is not None:
        return Snapshot.of(
            f"REDIRECT {response.status_code} {redirect_reason} to "
            + response.headers.get("Location", "<unknown>")
        )
    else:
        return Snapshot.of(response.data.decode()).plus_facet("status", response.status)

def _pretty_print_html(html: str):
    return BeautifulSoup(html, "html.parser").prettify() if "<html" in html else None

def _html_to_md(html: str):
    if "<html" not in html:
        return None
    else:
        # Convert HTML to Markdown with cleanup
        clean_html = re.sub(r"<br.*?>", "", html)
        md_text = md(clean_html)
        return md_text.strip()

_HTML_LENS = (
    CompoundLens()
    .mutate_facet("", _pretty_print_html)
    .replace_all_regex("http://localhost:\\d+/", "https://demo.selfie.dev/")
    .set_facet_from("md", "", _html_to_md)
)

_WEB_CAMERA = Camera.of(_web_camera).with_lens(_HTML_LENS)

def web_selfie(response: TestResponse) -> StringSelfie:
    return expect_selfie(response, _WEB_CAMERA)
```

## Login Flow Example

Here's a real example of testing a login flow:

```python
def test_login_flow(client):
    # Test initial page
    web_selfie(client.get("/")).to_be("""<html>
 <body>
  <h1>
   Please login
  </h1>
  <form action="/login" method="post">
   <input name="email" placeholder="email" type="text"/>
   <input type="submit" value="login"/>
  </form>
 </body>
</html>

‚ïî‚ïê [md] ‚ïê‚ïó
Please login
‚ïî‚ïê [status] ‚ïê‚ïó
200 OK""")

    # Test login submission
    response = client.post("/login", data={"email": "user@domain.com"})
    expect_selfie(response.data.decode()).to_be("""
<html><body>
  <h1>Email sent!</h1>
  <p>Check your email for your login link.</p>
</body></html>""")

    # Test email content
    email = wait_for_incoming_email()
    expect_selfie(email).to_be({
        "to": "user@domain.com",
        "subject": "Login to example.com",
        "html_content": 'Click <a href="http://localhost/login-confirm/2Yw4aCQ">here</a> to login.',
    })
```

> ‚ö†Ô∏è **Note**: Some advanced features like garbage collection ([Issue #325](https://github.com/diffplug/selfie/issues/325)) and binary data handling are still under development.

## Advanced Features

> üöß **Work in Progress**:
> - Garbage collection for stale snapshots
> - Advanced binary data handling
> - Complex disk snapshot features

For more details on the implementation and available features, check out the [example tests](https://github.com/diffplug/selfie/tree/main/python/example-pytest-selfie/tests).

_Pull requests to improve the documentation are greatly appreciated, you can find the [source code here](https://github.com/diffplug/selfie)._
